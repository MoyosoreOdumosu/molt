# Build moltbot Ubuntu image on Ubuntu runner (avoids Subiquity storage bug on macOS).
# On macOS the installer ignores autoinstall storage and sticks at "Guided storage configuration".
# Run this workflow to produce the image; artifact: output/moltbot-ubuntu-22.04/ (qcow2).
name: Packer image (Ubuntu)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-system-x86

      - name: Install Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Prepare image build (host)
        working-directory: host
        run: |
          npm ci
          npm run build:pkg:linux
          cp config.a.test.json config.json
          npm run image:prepare
          bash infra/packer/prepare-autoinstall-ssh.sh

      - name: Packer build
        working-directory: host/infra/packer
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer-debug.log
        run: |
          packer init -upgrade .
          # accelerator=none, qemu_display=none: GitHub runners have no KVM; cocoa is macOS-only
          packer build -force \
            -var "accelerator=none" \
            -var "qemu_display=none" \
            -var "moltbot_binary=../../releases/moltbot-host" \
            -var "moltbot_config=../../config.packer.json" \
            -var "release_manifest=../../releases/latest.json" \
            .

      - name: Upload Packer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs
          if-no-files-found: warn
          path: |
            host/infra/packer/packer-debug.log
            host/infra/packer/packer-build.log
            host/infra/packer/serial.log

      - name: Upload image artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: moltbot-ubuntu-22.04
          path: host/infra/packer/output/moltbot-ubuntu-22.04/

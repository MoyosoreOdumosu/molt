# Build moltbot Ubuntu image on Ubuntu runner using cloud image boot (no ISO+VNC autoinstall).
# Run this workflow to produce the image; artifact: output/moltbot-ubuntu-22.04/ (qcow2).
name: Packer image (Ubuntu)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-system-x86

      - name: Prepare cloud base image
        run: |
          set -euo pipefail
          BASE_URL="https://cloud-images.ubuntu.com/releases/jammy/release/ubuntu-22.04-server-cloudimg-amd64.img"
          SUMS_URL="https://cloud-images.ubuntu.com/releases/jammy/release/SHA256SUMS"
          BASE_IMG="/tmp/ubuntu-22.04-server-cloudimg-amd64.img"

          sudo apt-get update
          sudo apt-get install -y libguestfs-tools

          curl -fsSL "$BASE_URL" -o "$BASE_IMG"
          curl -fsSL "$SUMS_URL" -o /tmp/SHA256SUMS

          expected="$(awk '/ubuntu-22.04-server-cloudimg-amd64.img$/ {print $1; exit}' /tmp/SHA256SUMS)"
          actual="$(sha256sum "$BASE_IMG" | awk '{print $1}')"
          if [[ -z "$expected" || "$expected" != "$actual" ]]; then
            echo "Cloud image checksum mismatch" >&2
            exit 1
          fi

          sudo virt-customize -a "$BASE_IMG" \
            --run-command "id -u ubuntu >/dev/null 2>&1 || useradd -m -s /bin/bash -G sudo ubuntu" \
            --run-command "mkdir -p /home/ubuntu/.ssh && chown -R ubuntu:ubuntu /home/ubuntu/.ssh && chmod 700 /home/ubuntu/.ssh" \
            --run-command "echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/90-packer-ubuntu && chmod 440 /etc/sudoers.d/90-packer-ubuntu" \
            --ssh-inject "ubuntu:file:${GITHUB_WORKSPACE}/host/infra/packer/packer_ssh_ed25519.pub"

          customized="$(sha256sum "$BASE_IMG" | awk '{print $1}')"
          echo "PACKER_BASE_IMG_CHECKSUM=sha256:${customized}" >> "$GITHUB_ENV"

      - name: Install Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.0"

      - name: Prepare image build (host)
        working-directory: host
        run: |
          npm ci
          npm run build:pkg:linux
          cp config.a.test.json config.json
          npm run image:prepare
          bash infra/packer/prepare-autoinstall-ssh.sh

      - name: Packer build
        working-directory: host/infra/packer
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer-debug.log
        run: |
          packer init -upgrade .
          # accelerator=none, qemu_display=none: GitHub runners have no KVM; cloud image path avoids VNC typing.
          packer build -force \
            -var "accelerator=none" \
            -var "qemu_display=none" \
            -var "ubuntu_cloud_image_url=/tmp/ubuntu-22.04-server-cloudimg-amd64.img" \
            -var "ubuntu_cloud_image_checksum=${PACKER_BASE_IMG_CHECKSUM}" \
            -var "ssh_timeout=90m" \
            -var "ssh_handshake_attempts=1200" \
            -var "moltbot_binary=../../releases/moltbot-host" \
            -var "moltbot_config=../../config.packer.json" \
            -var "release_manifest=../../releases/latest.json" \
            .

      - name: Upload Packer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs
          if-no-files-found: warn
          path: |
            host/infra/packer/packer-debug.log
            host/infra/packer/packer-build.log
            host/infra/packer/serial.log

      - name: Upload image artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: moltbot-ubuntu-22.04
          path: host/infra/packer/output/moltbot-ubuntu-22.04/

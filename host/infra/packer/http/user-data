#cloud-config
autoinstall:
  version: 1
  # Do not add refresh-installer here: it can switch installer to manual mode (LP #1999902)
  # and cause "Waiting for SSH" to hang. If you see "Installer update available", press Enter once.
  # Minimal storage test: if this still shows guided storage, Subiquity is not applying storage at all.
  storage:
    layout:
      name: direct
  identity:
    hostname: moltbot
    username: ubuntu
    # sha512crypt hash for password "ubuntu"
    password: "$6$ewww/CXB.YAGmEns$agfGwHnEGYH0KGIQawkmV75H6MHLbEfKvvES3QkHWqegPjKjrdBfbwu5.ohmE/l312oJE9fQK5y5b.FdXNucv."
  ssh:
    install-server: true
    allow-pw: true
    authorized-keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPeTqI39VOfMtR7GMuM+dMCwAFYcM3j/jJaQoWPUbNZ9 user@UserdeMacBook-Air.local"
  packages:
    - openssh-server
    - curl
    - ca-certificates
  # Defense-in-depth: reapply ubuntu/ubuntu and password auth in target.
  late-commands:
    - curtin in-target --target=/target -- bash -c "echo 'ubuntu:ubuntu' | chpasswd"
    - curtin in-target --target=/target -- bash -c "sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config"
